name: Zip changed deployment files on PR merge

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  zip_on_merge:
    if: ${{ github.event.pull_request.merged == true }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: If merge commit exists, checkout merge commit
        run: |
          if [ -n "${{ github.event.pull_request.merge_commit_sha }}" ]; then
            git fetch --no-tags origin ${{ github.event.pull_request.merge_commit_sha }}
            git checkout ${{ github.event.pull_request.merge_commit_sha }}
          fi

      - name: Get list of files changed in the PR
        uses: actions/github-script@v6
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) core.setFailed('No pull_request found in the event context');
            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });
            require('fs').writeFileSync('changed_files.txt', files.map(f => f.filename).join('\n'));

      - name: Create ZIP(s) for changed files starting from crmv267/
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p artifacts
          count=0
          if [ -f changed_files.txt ]; then
            while IFS= read -r f || [ -n "$f" ]; do
              [ -z "$f" ] && continue
              
              # Only consider files under deployments/
              if [[ "$f" == deployments/** ]]; then
                # Check if file exists, else try restoring from merge commit
                if [ ! -f "$f" ] && [ -n "${{ github.event.pull_request.merge_commit_sha }}" ]; then
                  mkdir -p "$(dirname "$f")"
                  git show "${{ github.event.pull_request.merge_commit_sha }}:${f}" > "$f" || true
                fi

                # Ensure it exists before zipping
                if [ -f "$f" ]; then
                  # Find path starting from 'crmv267'
                  relpath=$(echo "$f" | sed -n 's#.*\(crmv267/.*\)#\1#p')
                  
                  if [ -n "$relpath" ]; then
                    # Create temp directory structure preserving path
                    mkdir -p "tempdir/$(dirname "$relpath")"
                    cp "$f" "tempdir/$relpath"

                    # Zip preserving internal structure
                    zip_path="artifacts/${relpath//\//_}.zip"
                    (cd tempdir && zip -r "../$zip_path" "crmv267")

                    rm -rf tempdir
                    echo "Zipped $relpath -> $zip_path"
                    count=$((count+1))
                  else
                    echo "Skipping $f (no crmv267 in path)"
                  fi
                fi
              fi
            done < changed_files.txt
          fi
          echo "Created $count zip(s) in artifacts/"

      - name: Upload created zip files as GitHub artifact (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-zip-artifacts
          path: artifacts/*.zip

      - name: Authenticate to GCP (use repo secret)
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY1 }}

      - name: Setup gcloud and export ADC
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT }}
          export_default_credentials: true

      - name: Debug GCP auth and bucket access
        run: |
          echo "gcloud active account:"
          gcloud auth list --format="value(account)" || true
          echo "gcloud project:"
          gcloud config get-value project || true
          echo "Attempting bucket list:"
          gsutil ls gs://${{ secrets.GCS_BUCKET }} || true

      - name: Upload created zips to GCS
        shell: bash
        env:
          GCS_BUCKET: ${{ secrets.GCS_BUCKET }}
        run: |
          DST="gs://${GCS_BUCKET}/${{ github.run_id }}/"
          echo "Uploading artifacts/*.zip -> $DST"
          if compgen -G "artifacts/*.zip" > /dev/null; then
            gsutil -m cp artifacts/*.zip "${DST}"
            echo "Upload finished"
          else
            echo "No zip files to upload"
          fi
